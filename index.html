<!DOCTYPE html>
<html>
<head>
  <title>File Uploader</title>
  <style>
    .file-upload {
      display: none;
    }
    .file-upload-label {
      padding: 10px;
      background-color: #eaeaea;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    .file-list {
      margin-top: 20px;
    }
    .file-list-item {
      margin-bottom: 10px;
    }
    .download-link {
      margin-right: 10px;
      color: #0099ff;
    }

    .download-link:visited {
      color:#0099ff;
    }
    .storage-info {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <input type="file" id="file-upload" class="file-upload">
  <label for="file-upload" class="file-upload-label">Choose a file...</label>

  <div class="file-list">
    <h3>Files:</h3>
    <ul id="file-list"></ul>
  </div>

  <div class="storage-info">
    <h3>Storage Information:</h3>
    <p id="storage-space"></p>
  </div>

  <script>
    const fileInput = document.getElementById('file-upload');
    fileInput.addEventListener('change', handleFileUpload);

    function updateFileList(files) {
      const fileList = document.getElementById('file-list');
      fileList.innerHTML = '';

      files.forEach((file) => {
        const listItem = document.createElement('li');

        const downloadLink = document.createElement('a');
        downloadLink.href = '/download/' + file;
        downloadLink.className = 'download-link';
        downloadLink.textContent = 'Download';

        const fileName = document.createElement('span');
        fileName.textContent = file;

        listItem.appendChild(downloadLink);
        listItem.appendChild(fileName);

        fileList.appendChild(listItem);
      });
    }

    function updateStorageSpace(space) {
      const storageSpace = document.getElementById('storage-space');
      storageSpace.textContent = 'Remaining storage space: ' + space;
    }

    fetch('/files')
      .then((response) => response.json())
      .then((data) => {
        updateFileList(data);
      })
      .catch((error) => {
        console.error('Error fetching file list:', error);
      });

    fetch('/storage')
      .then((response) => response.text())
      .then((data) => {
        updateStorageSpace(data);
      })
      .catch((error) => {
        console.error('Error fetching storage space:', error);
      });

    function handleFileUpload(event) {
      const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = function() {
        const fileData = reader.result;

        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:3000/upload', true);
        xhr.setRequestHeader('X-Original-Filename', file.name);

        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
            console.log('File uploaded successfully:', xhr.responseText);
            fetch('/files')
              .then((response) => response.json())
              .then((data) => {
                updateFileList(data);
              })
              .catch((error) => {
                console.error('Error fetching file list:', error);
              });
            fetch('/storage')
              .then((response) => response.text())
              .then((data) => {
                updateStorageSpace(data);
              })
              .catch((error) => {
                console.error('Error fetching storage space:', error);
              });
          } else if (xhr.readyState === 4 && xhr.status !== 200) {
            console.error('Error uploading file:', xhr.status);
          }
        };

        xhr.send(fileData);
      };

      reader.readAsDataURL(file);
    }
  </script>
</body>
</html>
